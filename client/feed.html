<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Feed Viewer</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        body {
            padding: var(--spacing-xl);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            background: var(--color-bg-secondary);
            padding: var(--spacing-lg) var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }

        .page-header h1 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* Feed Info Card */
        .feed-info-card {
            background: var(--color-bg-secondary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        .feed-info-card h2 {
            font-size: 16px;
            margin-bottom: var(--spacing-lg);
            color: var(--color-text-secondary);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
        }

        .info-item {
            background: var(--color-bg-primary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
        }

        .info-label {
            font-size: 11px;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            margin-bottom: var(--spacing-xs);
        }

        .info-value {
            font-size: 14px;
            color: var(--color-text-primary);
            font-weight: 500;
        }

        /* Status Badge */
        .feed-status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .feed-status-badge.online {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .feed-status-badge.vehicles {
            background: var(--color-vehicle-bg);
            color: var(--color-vehicle);
        }

        .feed-status-badge.offline {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .feed-status-badge .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Feed Viewer */
        .feed-viewer {
            background: var(--color-bg-secondary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
        }

        .feed-image-container {
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .feed-image {
            width: 100%;
            max-width: 1200px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .feed-image.hidden {
            display: none;
        }

        .feed-loading,
        .feed-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            padding: var(--spacing-2xl);
            text-align: center;
        }

        .feed-loading {
            color: var(--color-text-secondary);
        }

        .feed-error {
            color: var(--color-error);
        }

        .feed-error.hidden,
        .feed-loading.hidden {
            display: none;
        }

        /* Controls */
        .feed-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            flex-wrap: wrap;
        }

        .refresh-info {
            font-size: 13px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        /* Detection Info */
        .detection-card {
            background: var(--color-bg-secondary);
            padding: var(--spacing-xl);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--color-vehicle);
        }

        .detection-card h2 {
            font-size: 16px;
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            color: var(--color-vehicle);
        }

        .detection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .detection-stat {
            background: var(--color-bg-primary);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            text-align: center;
        }

        .detection-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-accent);
        }

        .detection-stat-label {
            font-size: 11px;
            color: var(--color-text-tertiary);
            text-transform: uppercase;
            margin-top: var(--spacing-xs);
        }

        /* Vehicle Types */
        .vehicle-types {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .vehicle-type-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--color-bg-primary);
            border-radius: var(--radius-full);
            font-size: 12px;
            color: var(--color-text-primary);
        }

        .vehicle-type-badge svg {
            color: var(--color-accent);
        }

        /* Fullscreen button */
        .fullscreen-btn {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            cursor: pointer;
            color: white;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .feed-image-container:hover .fullscreen-btn {
            opacity: 1;
        }

        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        /* Refresh Speed Control */
        .refresh-speed-control {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .refresh-speed-control label {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .refresh-speed-control select {
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 13px;
            cursor: pointer;
        }

        .refresh-speed-control select:hover {
            border-color: var(--color-border-hover);
        }

        .refresh-speed-control select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: var(--spacing-md);
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-header h1 {
                font-size: 18px;
            }

            .header-actions {
                width: 100%;
            }

            .header-actions .btn {
                flex: 1;
            }

            .feed-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1 id="feedTitle">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2"/>
                    <path d="M8 21h8M12 17v4"/>
                </svg>
                CCTV Feed Viewer
            </h1>
            <div class="header-actions">
                <a href="map.html" class="btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                        <circle cx="12" cy="10" r="3"/>
                    </svg>
                    Map
                </a>
                <a href="index.html" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Grid View
                </a>
            </div>
        </header>

        <section class="feed-info-card">
            <h2>Feed Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Feed ID</div>
                    <div class="info-value" id="feedId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Road Name</div>
                    <div class="info-value" id="roadName">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Location</div>
                    <div class="info-value" id="location">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Direction</div>
                    <div class="info-value" id="direction">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        <span class="feed-status-badge" id="statusBadge">
                            <span class="status-dot"></span>
                            <span>Checking...</span>
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <section class="feed-viewer">
            <div class="feed-image-container" id="imageContainer">
                <img id="feedImage" class="feed-image hidden" alt="CCTV Feed">

                <div class="feed-loading" id="loading">
                    <div class="loading-spinner"></div>
                    <span>Loading feed...</span>
                </div>

                <div class="feed-error hidden" id="error">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8v4M12 16v.01"/>
                    </svg>
                    <span>Failed to load feed</span>
                    <button class="btn" onclick="manualRefresh()">Retry</button>
                </div>

                <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Toggle fullscreen (F)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                </button>
            </div>

            <div class="feed-controls">
                <button class="btn active" id="autoRefreshBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9v-3m0-6V3"/>
                    </svg>
                    Auto Refresh: ON
                </button>
                <button class="btn" onclick="manualRefresh()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6M1 20v-6h6"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    Refresh Now
                </button>
                <div class="refresh-speed-control">
                    <label for="refreshSpeed">Speed:</label>
                    <select id="refreshSpeed" onchange="setRefreshSpeed(this.value)">
                        <option value="500">0.5s (Fastest)</option>
                        <option value="1000" selected>1s (Fast)</option>
                        <option value="2000">2s (Normal)</option>
                        <option value="5000">5s (Slow)</option>
                    </select>
                </div>
                <div class="refresh-info">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span>Updating every <strong id="refreshInterval">1</strong>s</span>
                </div>
            </div>
        </section>

        <section class="detection-card hidden" id="detectionInfo">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
                    <circle cx="7" cy="17" r="2"/>
                    <path d="M9 17h6"/>
                    <circle cx="17" cy="17" r="2"/>
                </svg>
                Vehicle Detection
            </h2>
            <div class="detection-stats">
                <div class="detection-stat">
                    <div class="detection-stat-value" id="vehicleCount">0</div>
                    <div class="detection-stat-label">Vehicles</div>
                </div>
                <div class="detection-stat">
                    <div class="detection-stat-value" id="confidence">-</div>
                    <div class="detection-stat-label">Avg Confidence</div>
                </div>
                <div class="detection-stat">
                    <div class="detection-stat-value" id="trackedCount">0</div>
                    <div class="detection-stat-label">Tracked</div>
                </div>
            </div>
            <div class="vehicle-types" id="vehicleTypes"></div>
        </section>
    </div>

    <script src="scripts/utils.js"></script>
    <script>
        // Configuration
        const hostname = window.location.hostname;
        const API_BASE = `http://${hostname}:8001`;
        let REFRESH_INTERVAL = 1000; // Default to 1 second for faster updates

        // State
        let feedId = null;
        let autoRefresh = true;
        let refreshTimer = null;
        let feedData = null;

        // DOM Elements
        const elements = {
            feedTitle: document.getElementById('feedTitle'),
            feedId: document.getElementById('feedId'),
            roadName: document.getElementById('roadName'),
            location: document.getElementById('location'),
            direction: document.getElementById('direction'),
            statusBadge: document.getElementById('statusBadge'),
            feedImage: document.getElementById('feedImage'),
            loading: document.getElementById('loading'),
            error: document.getElementById('error'),
            autoRefreshBtn: document.getElementById('autoRefreshBtn'),
            detectionInfo: document.getElementById('detectionInfo'),
            vehicleCount: document.getElementById('vehicleCount'),
            confidence: document.getElementById('confidence'),
            trackedCount: document.getElementById('trackedCount'),
            vehicleTypes: document.getElementById('vehicleTypes'),
            imageContainer: document.getElementById('imageContainer')
        };

        // Get feed ID from URL
        function getFeedIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Load feed metadata
        async function loadFeedInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/feeds`);
                const data = await response.json();

                feedData = data.feeds.find(f => f.id === feedId);

                if (feedData) {
                    document.title = `CCTV: ${feedData.roadName || feedId}`;
                    elements.feedTitle.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2"/>
                            <path d="M8 21h8M12 17v4"/>
                        </svg>
                        ${feedData.roadName || 'Unknown'} - ${feedData.locationMile || feedId}
                    `;
                    elements.feedId.textContent = feedData.id;
                    elements.roadName.textContent = feedData.roadName || 'N/A';
                    elements.location.textContent = feedData.locationMile || 'N/A';
                    elements.direction.textContent = feedData.direction || 'N/A';

                    updateStatus(data.status[feedId], data.vehicleDetected[feedId]);
                }
            } catch (error) {
                console.error('Error loading feed info:', error);
                Toast.error('Failed to load feed information');
            }
        }

        // Update status badge
        function updateStatus(isWorking, hasVehicles) {
            let statusClass, statusText;

            if (!isWorking) {
                statusClass = 'offline';
                statusText = 'Offline';
            } else if (hasVehicles) {
                statusClass = 'vehicles';
                statusText = 'Vehicles Detected';
                elements.detectionInfo.classList.remove('hidden');
            } else {
                statusClass = 'online';
                statusText = 'Online';
            }

            elements.statusBadge.className = `feed-status-badge ${statusClass}`;
            elements.statusBadge.innerHTML = `
                <span class="status-dot"></span>
                <span>${statusText}</span>
            `;
        }

        // Load feed image
        function loadFeedImage() {
            const timestamp = Date.now();
            const newSrc = `${API_BASE}/api/feeds/${feedId}/snapshot?t=${timestamp}`;

            // Create a new image to preload
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';

            tempImg.onload = () => {
                elements.feedImage.src = newSrc;
                elements.loading.classList.add('hidden');
                elements.error.classList.add('hidden');
                elements.feedImage.classList.remove('hidden');
            };

            tempImg.onerror = () => {
                elements.loading.classList.add('hidden');
                elements.error.classList.remove('hidden');
                elements.feedImage.classList.add('hidden');
            };

            tempImg.src = newSrc;
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh;

            if (autoRefresh) {
                elements.autoRefreshBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9v-3m0-6V3"/>
                    </svg>
                    Auto Refresh: ON
                `;
                elements.autoRefreshBtn.classList.add('active');
                startAutoRefresh();
            } else {
                elements.autoRefreshBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9v-3m0-6V3"/>
                    </svg>
                    Auto Refresh: OFF
                `;
                elements.autoRefreshBtn.classList.remove('active');
                stopAutoRefresh();
            }
        }

        // Manual refresh
        function manualRefresh() {
            loadFeedImage();
            loadFeedInfo();
        }

        // Start auto refresh
        function startAutoRefresh() {
            if (refreshTimer) return;

            // Only refresh the image at high frequency
            refreshTimer = setInterval(() => {
                loadFeedImage();
            }, REFRESH_INTERVAL);
        }

        // Stop auto refresh
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        // Set refresh speed
        function setRefreshSpeed(speed) {
            REFRESH_INTERVAL = parseInt(speed);
            document.getElementById('refreshInterval').textContent = (REFRESH_INTERVAL / 1000);

            // Restart auto refresh with new speed if enabled
            if (autoRefresh) {
                stopAutoRefresh();
                startAutoRefresh();
            }

            Toast.info(`Refresh speed set to ${REFRESH_INTERVAL / 1000}s`);
        }

        // Toggle fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                elements.imageContainer.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Event listeners
        elements.autoRefreshBtn.addEventListener('click', toggleAutoRefresh);

        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

            if (e.key === 'f' || e.key === 'F') {
                toggleFullscreen();
            }
            if (e.key === 'r' || e.key === 'R') {
                manualRefresh();
            }
            if (e.key === ' ') {
                e.preventDefault();
                toggleAutoRefresh();
            }
        });

        // Initialize
        feedId = getFeedIdFromUrl();

        if (!feedId) {
            elements.loading.classList.add('hidden');
            elements.error.classList.remove('hidden');
            elements.error.innerHTML = `
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 8v4M12 16v.01"/>
                </svg>
                <span>No feed ID provided</span>
                <span style="font-size: 13px; color: var(--color-text-secondary);">Select a feed from the Grid View to watch it here.</span>
                <a href="index.html" class="btn btn-primary" style="margin-top: var(--spacing-md);">Go to Grid View</a>
            `;
        } else {
            loadFeedInfo();
            loadFeedImage();
            startAutoRefresh();
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
