<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan CCTV Map View</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        .header {
            position: absolute;
            top: 10px;
            left: 50px;
            right: 10px;
            z-index: 1000;
            background: #2d2d2d;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            margin: 0;
            color: #ffffff;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
        }

        .stat-label {
            color: #888;
            font-size: 12px;
        }

        .filters {
            position: absolute;
            top: 90px;
            left: 50px;
            z-index: 1000;
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            min-width: 250px;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #444;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #0066cc;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .btn-secondary {
            background: #444;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn:hover {
            opacity: 1;
        }

        /* Custom marker styles */
        .marker-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .marker-working {
            background: #10b981;
        }

        .marker-working-vehicles {
            background: #ef4444;
        }

        .marker-offline {
            background: #9ca3af;
        }

        /* Popup styles */
        .leaflet-popup-content {
            margin: 10px;
            min-width: 250px;
        }

        .popup-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            color: #1f2937;
        }

        .popup-info {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .popup-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 5px;
        }

        .status-working {
            background: #d1fae5;
            color: #065f46;
        }

        .status-vehicles {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-offline {
            background: #e5e7eb;
            color: #374151;
        }

        .popup-image {
            width: 100%;
            margin-top: 10px;
            border-radius: 4px;
        }

        .popup-buttons {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .popup-btn {
            flex: 1;
            padding: 6px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            background: #2563eb;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Taiwan Highway CCTV Map</h1>
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="totalFeeds">0</div>
                <div class="stat-label">Total Feeds</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="workingFeeds">0</div>
                <div class="stat-label">Online</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="vehicleFeeds">0</div>
                <div class="stat-label">Vehicles Detected</div>
            </div>
        </div>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Search by Road</label>
            <input type="text" id="roadFilter" placeholder="e.g., ÂúãÈÅì1Ëôü">
        </div>
        <div class="filter-group">
            <label>Vehicle Detection</label>
            <select id="vehicleFilter">
                <option value="all">All Feeds</option>
                <option value="with_vehicles">With Vehicles</option>
                <option value="no_vehicles">No Vehicles</option>
            </select>
        </div>
        <div class="filter-buttons">
            <button class="btn btn-primary" onclick="applyFilters()">Apply</button>
            <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        const API_BASE = 'http://localhost:8001';
        const WS_URL = 'ws://localhost:8001';
        let map;
        let markers = L.markerClusterGroup();
        let allFeeds = [];
        let feedMarkers = {};  // Map feed_id to marker object
        let ws = null;
        let wsReconnectTimeout = null;

        // Initialize map centered on Taiwan
        function initMap() {
            map = L.map('map').setView([23.8, 121.0], 8);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            map.addLayer(markers);
        }

        // Create custom marker icon
        function createMarkerIcon(isWorking, hasVehicles) {
            let className = 'marker-icon ';
            if (!isWorking) {
                className += 'marker-offline';
            } else if (hasVehicles) {
                className += 'marker-working-vehicles';
            } else {
                className += 'marker-working';
            }

            const icon = hasVehicles ? '‚óè' : (isWorking ? '‚óè' : '‚óè');

            return L.divIcon({
                html: `<div class="${className}">${icon}</div>`,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
        }

        // Create popup content
        function createPopup(feed) {
            const status = !feed.isWorking ? 'Offline' : (feed.hasVehicles ? 'Vehicles Detected' : 'Online');
            const statusClass = !feed.isWorking ? 'status-offline' : (feed.hasVehicles ? 'status-vehicles' : 'status-working');

            return `
                <div>
                    <div class="popup-title">${feed.roadName || 'Unknown Road'}</div>
                    <div class="popup-info">Location: ${feed.locationMile || 'Unknown location'}</div>
                    <div class="popup-info">Direction: ${feed.direction || 'N/A'}</div>
                    <div class="popup-info">ID: ${feed.id}</div>
                    <div class="popup-status ${statusClass}">${status}</div>
                    ${feed.isWorking ? `
                        <img class="popup-image" src="${API_BASE}/api/feeds/${feed.id}/snapshot" alt="Feed snapshot" onerror="this.style.display='none'">
                        <div class="popup-buttons">
                            <button class="popup-btn" onclick="openFeed('${feed.id}')">View Feed</button>
                            <button class="popup-btn" onclick="viewHistory('${feed.id}')">History</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Load feed data from API
        async function loadFeeds() {
            try {
                const response = await fetch(`${API_BASE}/api/map`);
                const data = await response.json();

                allFeeds = data.features;
                displayFeeds(allFeeds);
                updateStats();
            } catch (error) {
                console.error('Error loading feeds:', error);
            }
        }

        // Display feeds on map
        function displayFeeds(features) {
            markers.clearLayers();
            feedMarkers = {};

            features.forEach(feature => {
                const { coordinates } = feature.geometry;
                const props = feature.properties;

                const marker = L.marker([coordinates[1], coordinates[0]], {
                    icon: createMarkerIcon(props.isWorking, props.hasVehicles)
                });

                marker.bindPopup(createPopup(props));
                markers.addLayer(marker);

                // Store reference for real-time updates
                feedMarkers[props.id] = {
                    marker: marker,
                    props: props,
                    coordinates: coordinates
                };
            });
        }

        // Update single marker (for WebSocket updates)
        function updateMarker(feedId, isWorking, hasVehicles) {
            const feedMarker = feedMarkers[feedId];
            if (!feedMarker) return;

            // Update properties
            feedMarker.props.isWorking = isWorking;
            feedMarker.props.hasVehicles = hasVehicles;

            // Update marker icon
            feedMarker.marker.setIcon(createMarkerIcon(isWorking, hasVehicles));

            // Update popup
            feedMarker.marker.setPopupContent(createPopup(feedMarker.props));
        }

        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                const stats = await response.json();

                document.getElementById('totalFeeds').textContent = stats.totalFeeds || 0;
                document.getElementById('workingFeeds').textContent = stats.workingFeeds || 0;
                document.getElementById('vehicleFeeds').textContent = stats.vehiclesDetectedFeeds || 0;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Apply filters
        async function applyFilters() {
            const road = document.getElementById('roadFilter').value.trim();
            const vehicleFilter = document.getElementById('vehicleFilter').value;

            let url = `${API_BASE}/api/search?`;
            if (road) url += `road=${encodeURIComponent(road)}&`;
            if (vehicleFilter !== 'all') {
                url += `has_vehicles=${vehicleFilter === 'with_vehicles'}&`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                // Convert feeds to GeoJSON features
                const features = data.feeds.map(feed => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(feed.lon || 0), parseFloat(feed.lat || 0)]
                    },
                    properties: {
                        id: feed.id,
                        roadName: feed.roadName,
                        locationMile: feed.locationMile,
                        description: feed.description,
                        direction: feed.direction,
                        isWorking: feed.status || false,
                        hasVehicles: feed.vehicleDetected || false
                    }
                })).filter(f => f.geometry.coordinates[0] !== 0 && f.geometry.coordinates[1] !== 0);

                displayFeeds(features);
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('roadFilter').value = '';
            document.getElementById('vehicleFilter').value = 'all';
            displayFeeds(allFeeds);
        }

        // Open feed in new window
        function openFeed(feedId) {
            window.open(`feed.html?id=${feedId}`, '_blank');
        }

        // View feed history
        function viewHistory(feedId) {
            alert(`History viewer for ${feedId} coming soon!`);
        }

        // WebSocket Connection for Real-Time Updates
        function connectWebSocket() {
            console.log('Map: Connecting to WebSocket...');
            ws = new WebSocket(`${WS_URL}/ws`);

            ws.onopen = () => {
                console.log('Map: WebSocket connected');
                if (wsReconnectTimeout) {
                    clearTimeout(wsReconnectTimeout);
                    wsReconnectTimeout = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Map: Error parsing WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Map: WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('Map: WebSocket disconnected. Reconnecting in 5 seconds...');
                ws = null;
                wsReconnectTimeout = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'detection':
                    // Update marker to show vehicles detected
                    updateMarker(data.feed_id, true, true);
                    updateStats();
                    const detectionInfo = data.data || {};
                    const vehicleCount = detectionInfo.vehicle_count || 'unknown';
                    console.log(`Map: üöó Vehicle detected at ${data.feed_id} - ${vehicleCount} vehicles`);
                    break;

                case 'feed_status':
                    // Update marker status
                    updateMarker(data.feed_id, data.is_working, data.has_vehicles);
                    updateStats();
                    break;

                case 'heartbeat':
                    // Server heartbeat - connection is alive
                    console.debug('Map: WebSocket heartbeat received');
                    break;

                case 'stats':
                    // System statistics update - could update the header stats
                    if (data.data) {
                        document.getElementById('totalFeeds').textContent = data.data.totalFeeds || 0;
                        document.getElementById('workingFeeds').textContent = data.data.workingFeeds || 0;
                        document.getElementById('vehicleFeeds').textContent = data.data.vehiclesDetectedFeeds || 0;
                    }
                    break;

                default:
                    console.log('Map: Unknown WebSocket message type:', data.type);
            }
        }

        // Initialize
        initMap();
        loadFeeds();
        connectWebSocket();

        // Refresh every 30 seconds
        setInterval(() => {
            loadFeeds();
        }, 30000);
    </script>
</body>
</html>
