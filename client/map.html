<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan CCTV Map View</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="styles/common.css">

    <style>
        body {
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        /* Floating Header */
        .map-header {
            position: absolute;
            top: var(--spacing-md);
            left: 60px;
            right: var(--spacing-md);
            z-index: 1000;
            background: var(--color-bg-secondary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .map-header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .map-header h1 {
            font-size: 18px;
            white-space: nowrap;
        }

        .map-stats {
            display: flex;
            gap: var(--spacing-xl);
        }

        .map-stat {
            text-align: center;
        }

        .map-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-accent);
        }

        .map-stat-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
        }

        /* Floating Filter Panel */
        .map-filters {
            position: absolute;
            top: 90px;
            left: 60px;
            z-index: 1000;
            background: var(--color-bg-secondary);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            min-width: 280px;
        }

        .filter-group {
            margin-bottom: var(--spacing-md);
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: var(--color-bg-input);
            color: var(--color-text-primary);
            transition: border-color var(--transition-normal);
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .filter-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
        }

        .filter-actions .btn {
            flex: 1;
        }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: var(--spacing-xl);
            left: 60px;
            z-index: 1000;
            background: var(--color-bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            text-transform: uppercase;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 12px;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .legend-dot.online { background: var(--color-success); }
        .legend-dot.vehicles { background: var(--color-error); }
        .legend-dot.offline { background: #9ca3af; }

        /* Connection Status */
        .map-connection {
            position: absolute;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            z-index: 1000;
        }

        /* Custom marker styles */
        .marker-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-fast);
        }

        .marker-icon:hover {
            transform: scale(1.1);
        }

        .marker-working {
            background: var(--color-success);
        }

        .marker-working-vehicles {
            background: var(--color-error);
            animation: pulse-marker 2s infinite;
        }

        .marker-offline {
            background: #9ca3af;
        }

        @keyframes pulse-marker {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        /* Popup styles */
        .leaflet-popup-content-wrapper {
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .leaflet-popup-content {
            margin: var(--spacing-md);
            min-width: 260px;
            color: var(--color-text-primary);
        }

        .leaflet-popup-tip {
            background: var(--color-bg-secondary);
        }

        .popup-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text-primary);
        }

        .popup-info {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
        }

        .popup-status {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            margin-top: var(--spacing-sm);
        }

        .popup-status.online {
            background: var(--color-success-bg);
            color: var(--color-success);
        }

        .popup-status.vehicles {
            background: var(--color-error-bg);
            color: var(--color-error);
        }

        .popup-status.offline {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .popup-image {
            width: 100%;
            margin-top: var(--spacing-md);
            border-radius: var(--radius-md);
            background: var(--color-bg-primary);
        }

        .popup-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .popup-actions .btn {
            flex: 1;
            padding: var(--spacing-sm);
            font-size: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .map-header {
                left: var(--spacing-md);
                flex-direction: column;
                align-items: stretch;
            }

            .map-header-left {
                flex-direction: column;
                align-items: flex-start;
            }

            .map-stats {
                width: 100%;
                justify-content: space-around;
            }

            .map-filters {
                left: var(--spacing-md);
                right: var(--spacing-md);
                top: auto;
                bottom: var(--spacing-xl);
                min-width: auto;
            }

            .map-legend {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="map-header">
        <div class="map-header-left">
            <h1>Taiwan Highway CCTV Map</h1>
            <a href="index.html" class="btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                Grid View
            </a>
        </div>
        <div class="map-stats">
            <div class="map-stat">
                <div class="map-stat-value" id="totalFeeds">0</div>
                <div class="map-stat-label">Total</div>
            </div>
            <div class="map-stat">
                <div class="map-stat-value" id="workingFeeds">0</div>
                <div class="map-stat-label">Online</div>
            </div>
            <div class="map-stat">
                <div class="map-stat-value" id="vehicleFeeds">0</div>
                <div class="map-stat-label">Vehicles</div>
            </div>
        </div>
    </div>

    <div class="map-filters" id="filtersPanel">
        <div class="filter-group">
            <label for="roadFilter">Search by Road</label>
            <input type="text" id="roadFilter" placeholder="e.g., National Highway 1">
        </div>
        <div class="filter-group">
            <label for="vehicleFilter">Vehicle Detection</label>
            <select id="vehicleFilter">
                <option value="all">All Feeds</option>
                <option value="with_vehicles">With Vehicles</option>
                <option value="no_vehicles">No Vehicles</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" id="applyFiltersBtn">Apply</button>
            <button class="btn" id="resetFiltersBtn">Reset</button>
        </div>
    </div>

    <div class="map-legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item">
            <div class="legend-dot online"></div>
            <span>Online</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot vehicles"></div>
            <span>Vehicles Detected</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot offline"></div>
            <span>Offline</span>
        </div>
    </div>

    <div class="map-connection">
        <div id="connectionStatus" class="connection-status disconnected">
            <span class="connection-dot"></span>
            <span class="connection-text">Connecting...</span>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="scripts/utils.js"></script>

    <script>
        // Configuration
        const hostname = window.location.hostname;
        const API_BASE = `http://${hostname}:8001`;
        const WS_URL = `ws://${hostname}:8001`;

        // State
        let map;
        let markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        let allFeeds = [];
        let feedMarkers = {};
        let ws = null;
        let wsReconnectTimeout = null;

        // Initialize map
        function initMap() {
            map = L.map('map', {
                zoomControl: true
            }).setView([23.8, 121.0], 8);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            map.addLayer(markers);

            // Move zoom control to right side
            map.zoomControl.setPosition('topright');
        }

        // Create marker icon
        function createMarkerIcon(isWorking, hasVehicles) {
            let className = 'marker-icon ';
            if (!isWorking) {
                className += 'marker-offline';
            } else if (hasVehicles) {
                className += 'marker-working-vehicles';
            } else {
                className += 'marker-working';
            }

            return L.divIcon({
                html: `<div class="${className}"></div>`,
                className: '',
                iconSize: [28, 28],
                iconAnchor: [14, 14],
                popupAnchor: [0, -14]
            });
        }

        // Create popup content
        function createPopup(feed) {
            const status = !feed.isWorking ? 'Offline' : (feed.hasVehicles ? 'Vehicles Detected' : 'Online');
            const statusClass = !feed.isWorking ? 'offline' : (feed.hasVehicles ? 'vehicles' : 'online');

            return `
                <div>
                    <div class="popup-title">${feed.roadName || 'Unknown Road'}</div>
                    <div class="popup-info">Location: ${feed.locationMile || 'Unknown'}</div>
                    <div class="popup-info">Direction: ${feed.direction || 'N/A'}</div>
                    <div class="popup-info">ID: ${feed.id}</div>
                    <div class="popup-status ${statusClass}">${status}</div>
                    ${feed.isWorking ? `
                        <img class="popup-image"
                             src="${API_BASE}/api/feeds/${feed.id}/snapshot?t=${Date.now()}"
                             alt="Feed preview"
                             onerror="this.style.display='none'">
                        <div class="popup-actions">
                            <button class="btn btn-primary" onclick="openFeed('${feed.id}')">View Feed</button>
                            <button class="btn" onclick="centerOnFeed('${feed.id}')">Zoom In</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Load feeds from API
        async function loadFeeds() {
            try {
                const response = await fetch(`${API_BASE}/api/map`);
                const data = await response.json();

                allFeeds = data.features;
                displayFeeds(allFeeds);
                updateStats();
            } catch (error) {
                console.error('Error loading feeds:', error);
                Toast.error('Failed to load feed data');
            }
        }

        // Display feeds on map
        function displayFeeds(features) {
            markers.clearLayers();
            feedMarkers = {};

            features.forEach(feature => {
                const { coordinates } = feature.geometry;
                const props = feature.properties;

                const marker = L.marker([coordinates[1], coordinates[0]], {
                    icon: createMarkerIcon(props.isWorking, props.hasVehicles)
                });

                marker.bindPopup(createPopup(props), {
                    maxWidth: 300
                });

                markers.addLayer(marker);

                feedMarkers[props.id] = {
                    marker: marker,
                    props: props,
                    coordinates: coordinates
                };
            });
        }

        // Update single marker
        function updateMarker(feedId, isWorking, hasVehicles) {
            const feedMarker = feedMarkers[feedId];
            if (!feedMarker) return;

            feedMarker.props.isWorking = isWorking;
            feedMarker.props.hasVehicles = hasVehicles;
            feedMarker.marker.setIcon(createMarkerIcon(isWorking, hasVehicles));
            feedMarker.marker.setPopupContent(createPopup(feedMarker.props));
        }

        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                const stats = await response.json();

                document.getElementById('totalFeeds').textContent = stats.totalFeeds || 0;
                document.getElementById('workingFeeds').textContent = stats.workingFeeds || 0;
                document.getElementById('vehicleFeeds').textContent = stats.vehiclesDetectedFeeds || 0;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Apply filters
        async function applyFilters() {
            const road = document.getElementById('roadFilter').value.trim();
            const vehicleFilter = document.getElementById('vehicleFilter').value;

            let url = `${API_BASE}/api/search?`;
            if (road) url += `road=${encodeURIComponent(road)}&`;
            if (vehicleFilter !== 'all') {
                url += `has_vehicles=${vehicleFilter === 'with_vehicles'}&`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                const features = data.feeds.map(feed => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(feed.lon || 0), parseFloat(feed.lat || 0)]
                    },
                    properties: {
                        id: feed.id,
                        roadName: feed.roadName,
                        locationMile: feed.locationMile,
                        description: feed.description,
                        direction: feed.direction,
                        isWorking: feed.status || false,
                        hasVehicles: feed.vehicleDetected || false
                    }
                })).filter(f => f.geometry.coordinates[0] !== 0 && f.geometry.coordinates[1] !== 0);

                displayFeeds(features);
                Toast.success(`Found ${features.length} feeds`);
            } catch (error) {
                console.error('Error applying filters:', error);
                Toast.error('Failed to apply filters');
            }
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('roadFilter').value = '';
            document.getElementById('vehicleFilter').value = 'all';
            displayFeeds(allFeeds);
            Toast.info('Filters reset');
        }

        // Open feed in new window
        function openFeed(feedId) {
            window.open(`feed.html?id=${feedId}`, '_blank');
        }

        // Center map on feed
        function centerOnFeed(feedId) {
            const feedMarker = feedMarkers[feedId];
            if (feedMarker) {
                map.setView([feedMarker.coordinates[1], feedMarker.coordinates[0]], 15);
            }
        }

        // WebSocket connection
        function connectWebSocket() {
            ConnectionStatus.init('connectionStatus');
            ConnectionStatus.setStatus('connecting');

            ws = new WebSocket(`${WS_URL}/ws`);

            ws.onopen = () => {
                console.log('Map: WebSocket connected');
                ConnectionStatus.setStatus('connected');
                if (wsReconnectTimeout) {
                    clearTimeout(wsReconnectTimeout);
                    wsReconnectTimeout = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                    ConnectionStatus.updateLastSeen();
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Map: WebSocket error:', error);
                ConnectionStatus.setStatus('disconnected');
            };

            ws.onclose = () => {
                console.log('Map: WebSocket disconnected');
                ws = null;
                ConnectionStatus.setStatus('disconnected');
                wsReconnectTimeout = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'detection':
                    updateMarker(data.feed_id, true, true);
                    updateStats();
                    break;

                case 'feed_status':
                    updateMarker(data.feed_id, data.is_working, data.has_vehicles);
                    updateStats();
                    break;

                case 'stats':
                    if (data.data) {
                        document.getElementById('totalFeeds').textContent = data.data.totalFeeds || 0;
                        document.getElementById('workingFeeds').textContent = data.data.workingFeeds || 0;
                        document.getElementById('vehicleFeeds').textContent = data.data.vehiclesDetectedFeeds || 0;
                    }
                    break;
            }
        }

        // Event listeners
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);

        document.getElementById('roadFilter').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') applyFilters();
        });

        // Initialize
        initMap();
        loadFeeds();
        connectWebSocket();

        // Refresh every 30 seconds
        setInterval(loadFeeds, 30000);
    </script>
</body>
</html>
