<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Highway CCTV Viewer - Real-time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
        }

        .header {
            background: #2d2d2d;
            padding: 20px;
            border-bottom: 2px solid #0066cc;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .map-button {
            padding: 8px 20px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .map-button:hover {
            background: #0052a3;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #444;
            background: #1a1a1a;
            color: white;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: 2px solid #444;
            background: #2d2d2d;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #3d3d3d;
            border-color: #0066cc;
        }

        .btn.active {
            background: #0066cc;
            border-color: #0066cc;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
            color: #888;
        }

        .stat span {
            color: #0066cc;
            font-weight: bold;
        }

        .grid-container {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .feed-card {
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .feed-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .feed-thumbnail {
            width: 100%;
            height: 200px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .feed-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .feed-thumbnail .loading {
            color: #888;
            font-size: 14px;
        }

        .feed-thumbnail .error {
            color: #ff6b6b;
            font-size: 14px;
        }

        .vehicle-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b00;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .feed-info {
            padding: 12px;
        }

        .feed-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .feed-location {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .feed-id {
            font-size: 11px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            font-size: 30px;
            color: #888;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-video {
            padding: 20px;
            text-align: center;
            background: #1a1a1a;
        }

        .modal-video img {
            max-width: 100%;
            max-height: 70vh;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .modal-details {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
        }

        .detail-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #fff;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 18px;
        }

        .refresh-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #0066cc;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Stream Out Modal Styles */
        .stream-modal {
            max-width: 500px;
            width: 90%;
        }

        .stream-config {
            padding: 20px;
        }

        .config-row {
            margin-bottom: 20px;
        }

        .config-row label {
            display: block;
            color: #ccc;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 5px;
            color: white;
            font-size: 14px;
        }

        .config-input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .toggle-label span {
            font-size: 16px;
            font-weight: bold;
        }

        .btn-primary {
            width: 100%;
            background: #0066cc;
            border-color: #0066cc;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .stream-info {
            margin-top: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 5px;
            font-size: 13px;
        }

        .stream-info p {
            margin-bottom: 10px;
            color: #0066cc;
        }

        .stream-info ul {
            margin-left: 20px;
            color: #888;
        }

        .stream-info li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            Taiwan Highway CCTV Viewer - Real-time
            <a href="map.html" class="map-button" target="_blank">
                Map View
            </a>
        </h1>
        <div class="stats">
            <div class="stat">Total: <span id="totalCount">0</span></div>
            <div class="stat">Displayed: <span id="displayedCount">0</span></div>
            <div class="stat">Online: <span id="workingCount">0</span></div>
            <div class="stat">Vehicles: <span id="vehicleCount">0</span></div>
            <div class="stat">Refresh Rate: <span id="refreshRate">0.0s</span></div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by location, road name, or ID...">
            </div>
            <div class="filter-buttons">
                <button class="btn active" id="showAllBtn" onclick="setFilter('all')">Show All</button>
                <button class="btn" id="showWorkingBtn" onclick="setFilter('working')">Working Only</button>
                <button class="btn" id="showOccupiedBtn" onclick="setFilter('occupied')">TAI Occupied</button>
                <button class="btn" id="streamOutBtn" onclick="openStreamOutModal()">Stream Out</button>
            </div>
        </div>
    </div>

    <div class="refresh-indicator" id="refreshIndicator">Updating feeds...</div>

    <div class="grid-container" id="feedGrid">
        <div class="no-results">Loading feeds from backend...</div>
    </div>

    <div class="modal" id="feedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-video" id="modalVideo"></div>
            <div class="modal-details" id="modalDetails"></div>
        </div>
    </div>

    <div class="modal" id="streamOutModal">
        <div class="modal-content stream-modal">
            <div class="modal-header">
                <h2>Stream Out Configuration</h2>
                <button class="modal-close" onclick="closeStreamOutModal()">&times;</button>
            </div>
            <div class="stream-config">
                <div class="config-row">
                    <label class="toggle-label">
                        <input type="checkbox" id="streamEnabled" onchange="toggleStreaming()">
                        <span>Enable Streaming</span>
                    </label>
                </div>

                <div class="config-row">
                    <label>Output Format:</label>
                    <select id="streamFormat" class="config-input" onchange="updateFormatFields()">
                        <option value="cot">CoT (Cursor on Target)</option>
                        <option value="lattice">Lattice (Anduril)</option>
                        <option value="json" disabled>JSON (Coming Soon)</option>
                    </select>
                </div>

                <div class="config-row cot-fields">
                    <label>Destination IP:</label>
                    <input type="text" id="streamIP" class="config-input" placeholder="192.168.1.100" value="127.0.0.1">
                </div>

                <div class="config-row cot-fields">
                    <label>Port:</label>
                    <input type="number" id="streamPort" class="config-input" placeholder="8087" value="8087" min="1" max="65535">
                </div>

                <div class="config-row lattice-fields" style="display: none;">
                    <label>Lattice API URL:</label>
                    <input type="text" id="latticeUrl" class="config-input" placeholder="https://your-sandbox.lattice.anduril.com">
                </div>

                <div class="config-row lattice-fields" style="display: none;">
                    <label>Environment Token:</label>
                    <input type="password" id="latticeToken" class="config-input" placeholder="Environment 'Lattice Auth Token'">
                    <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">Get from your environment details in Sandboxes</small>
                </div>

                <div class="config-row lattice-fields" style="display: none;">
                    <label>Sandbox Token:</label>
                    <input type="password" id="latticeSandboxToken" class="config-input" placeholder="Account-level Sandboxes Bearer Token">
                    <small style="color: #888; font-size: 12px; display: block; margin-top: 4px;">Create in Account & Security â†’ Bearer tokens (only for Sandboxes)</small>
                </div>

                <div class="config-row lattice-fields" style="display: none;">
                    <label>Integration Name:</label>
                    <input type="text" id="latticeIntegration" class="config-input" placeholder="taiwan-cctv" value="taiwan-cctv">
                </div>

                <div class="config-row">
                    <button class="btn btn-primary" onclick="saveStreamConfig()">Apply Configuration</button>
                </div>

                <div class="stream-info cot-info">
                    <p><strong>CoT Settings:</strong></p>
                    <ul>
                        <li>Protocol: UDP (fire and forget)</li>
                        <li>Marker Type: a-u-G (Unknown Ground)</li>
                        <li>Updates: Sent when vehicles detected</li>
                        <li>Callsign: TrafficCam-{ID}</li>
                    </ul>
                </div>

                <div class="stream-info lattice-info" style="display: none;">
                    <p><strong>Lattice Settings:</strong></p>
                    <ul>
                        <li>Protocol: HTTPS REST API</li>
                        <li>Entity Type: Unknown Ground</li>
                        <li>Updates: Real-time on vehicle detection</li>
                        <li>Expiry: 1 hour (auto-refresh)</li>
                    </ul>
                    <p><strong>Sandboxes Authentication:</strong></p>
                    <ul>
                        <li><strong>Environment Token:</strong> Get from environment details ("Lattice Auth Token")</li>
                        <li><strong>Sandbox Token:</strong> Create in Account & Security â†’ Bearer tokens</li>
                        <li>Both tokens required for Sandbox environments</li>
                        <li>Production only needs Environment Token</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8001';
        const WS_URL = 'ws://localhost:8001';
        const REFRESH_INTERVAL = 2000; // 2 seconds for grid
        const MODAL_REFRESH_INTERVAL = 500; // 0.5 seconds for modal

        let allFeeds = [];
        let feedStatus = {};
        let feedVehicleDetected = {};
        let displayedFeeds = [];
        let filterMode = 'all';
        let refreshIntervalId = null;
        let modalRefreshIntervalId = null;
        let currentModalFeedId = null;
        let ws = null;
        let wsReconnectTimeout = null;

        // Translate direction codes to English
        function translateDirection(dir) {
            const directions = {
                'N': 'North', 'S': 'South', 'E': 'East', 'W': 'West',
                'NE': 'Northeast', 'NW': 'Northwest', 'SE': 'Southeast', 'SW': 'Southwest',
                'C': 'Center'
            };
            return directions[dir] || dir;
        }

        // Create English description from location data
        function createEnglishDescription(feed) {
            const direction = translateDirection(feed.direction);
            return `${feed.roadName} at ${feed.locationMile} (${direction}bound)`;
        }

        // Load feeds from backend API
        async function loadFeeds() {
            try {
                const response = await fetch(`${API_URL}/api/feeds`);
                const data = await response.json();

                allFeeds = data.feeds;
                feedStatus = data.status;
                feedVehicleDetected = data.vehicleDetected || {};

                document.getElementById('totalCount').textContent = allFeeds.length;
                updateWorkingCount();
                displayFeeds(allFeeds);

                // Start auto-refresh
                startAutoRefresh();

            } catch (error) {
                console.error('Error loading feeds:', error);
                document.getElementById('feedGrid').innerHTML = '<div class="no-results">Error connecting to backend. Make sure the server is running on port 8001.</div>';
            }
        }

        // Display feeds in grid
        function displayFeeds(feeds) {
            displayedFeeds = feeds;
            const grid = document.getElementById('feedGrid');
            document.getElementById('displayedCount').textContent = feeds.length;

            if (feeds.length === 0) {
                grid.innerHTML = '<div class="no-results">No feeds found matching your criteria.</div>';
                return;
            }

            grid.innerHTML = feeds.map(feed => {
                const englishDesc = createEnglishDescription(feed);
                const isWorking = feedStatus[feed.id] || false;
                const hasVehicles = feedVehicleDetected[feed.id] || false;
                const vehicleBadge = hasVehicles ? '<div class="vehicle-badge">TAI OCCUPIED</div>' : '';
                return `
                    <div class="feed-card" onclick="openFeed('${feed.id}')" data-feed-id="${feed.id}">
                        <div class="feed-thumbnail" id="thumb-${feed.id}">
                            ${isWorking ? `<img src="${API_URL}/api/feeds/${feed.id}/snapshot?t=${Date.now()}" alt="${englishDesc}" class="feed-stream" crossorigin="anonymous" data-feed-id="${feed.id}">${vehicleBadge}` : '<div class="error">Offline</div>'}
                        </div>
                        <div class="feed-info">
                            <div class="feed-title">${feed.roadName || 'Unknown'} ${feed.locationMile || ''}</div>
                            <div class="feed-location">${englishDesc}</div>
                            <div class="feed-id">${feed.id}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Auto-refresh visible thumbnails
        function startAutoRefresh() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);

            refreshIntervalId = setInterval(async () => {
                const indicator = document.getElementById('refreshIndicator');
                indicator.style.display = 'block';

                const startTime = Date.now();

                // Update feed status from backend
                try {
                    const response = await fetch(`${API_URL}/api/feeds`);
                    const data = await response.json();
                    feedStatus = data.status;
                    feedVehicleDetected = data.vehicleDetected || {};
                    updateWorkingCount();
                } catch (error) {
                    console.error('Error refreshing feed status:', error);
                }

                // Update only VISIBLE feed thumbnails for performance
                const timestamp = Date.now();
                document.querySelectorAll('.feed-card').forEach(card => {
                    // Check if card is in viewport (simple check)
                    const rect = card.getBoundingClientRect();
                    const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

                    if (!isVisible) return; // Skip off-screen feeds

                    const feedId = card.dataset.feedId;
                    const thumbnail = card.querySelector('.feed-thumbnail');
                    const isWorking = feedStatus[feedId];
                    const hasVehicles = feedVehicleDetected[feedId] || false;

                    if (isWorking) {
                        // Check if image already exists
                        let img = thumbnail.querySelector('.feed-stream');
                        if (img) {
                            // Image exists, just refresh it
                            const baseSrc = img.src.split('?')[0];
                            img.src = `${baseSrc}?t=${timestamp}`;
                        } else {
                            // Feed came online, create image element
                            const feed = allFeeds.find(f => f.id === feedId);
                            if (feed) {
                                const englishDesc = createEnglishDescription(feed);
                                thumbnail.innerHTML = `<img src="${API_URL}/api/feeds/${feedId}/snapshot?t=${timestamp}" alt="${englishDesc}" class="feed-stream" crossorigin="anonymous" data-feed-id="${feedId}">`;
                            }
                        }

                        // Update vehicle badge
                        let badge = thumbnail.querySelector('.vehicle-badge');
                        if (hasVehicles && !badge) {
                            // Add badge if vehicles detected
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        } else if (!hasVehicles && badge) {
                            // Remove badge if no vehicles
                            badge.remove();
                        }
                    } else {
                        // Feed went offline, show error
                        if (!thumbnail.querySelector('.error')) {
                            thumbnail.innerHTML = '<div class="error">Offline</div>';
                        }
                    }
                });

                // Show actual refresh interval, not elapsed time
                document.getElementById('refreshRate').textContent = `${(REFRESH_INTERVAL / 1000).toFixed(1)}s`;

                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 500);

            }, REFRESH_INTERVAL);
        }

        // Update working count
        function updateWorkingCount() {
            const working = Object.values(feedStatus).filter(s => s).length;
            const vehicles = Object.values(feedVehicleDetected).filter(v => v).length;
            document.getElementById('workingCount').textContent = working;
            document.getElementById('vehicleCount').textContent = vehicles;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();

            const filtered = allFeeds.filter(feed => {
                const searchStr = `${feed.roadName} ${feed.locationMile} ${feed.id} ${feed.description}`.toLowerCase();
                return searchStr.includes(query);
            });

            applyFilters(filtered);
        });

        // Filter functionality
        function setFilter(mode) {
            filterMode = mode;

            document.getElementById('showAllBtn').classList.toggle('active', mode === 'all');
            document.getElementById('showWorkingBtn').classList.toggle('active', mode === 'working');
            document.getElementById('showOccupiedBtn').classList.toggle('active', mode === 'occupied');

            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allFeeds;

            if (searchQuery) {
                filtered = filtered.filter(feed => {
                    const searchStr = `${feed.roadName} ${feed.locationMile} ${feed.id} ${feed.description}`.toLowerCase();
                    return searchStr.includes(searchQuery);
                });
            }

            applyFilters(filtered);
        }

        function applyFilters(feeds) {
            if (filterMode === 'working') {
                feeds = feeds.filter(f => feedStatus[f.id]);
            } else if (filterMode === 'occupied') {
                feeds = feeds.filter(f => feedVehicleDetected[f.id]);
            }
            displayFeeds(feeds);
        }

        // Open feed in modal
        function openFeed(feedId) {
            const feed = allFeeds.find(f => f.id === feedId);
            if (!feed) return;

            // Clear any existing modal content first
            document.getElementById('modalVideo').innerHTML = '';

            currentModalFeedId = feedId;

            const englishDesc = createEnglishDescription(feed);
            const directionFull = translateDirection(feed.direction);

            document.getElementById('modalTitle').textContent = englishDesc;

            // Show modal
            document.getElementById('feedModal').classList.add('active');

            // Start fast refresh for modal
            updateModalImage();
            if (modalRefreshIntervalId) clearInterval(modalRefreshIntervalId);
            modalRefreshIntervalId = setInterval(updateModalImage, MODAL_REFRESH_INTERVAL);

            // Update details
            document.getElementById('modalDetails').innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${englishDesc}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Road</div>
                    <div class="detail-value">${feed.roadName}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Mile Marker</div>
                    <div class="detail-value">${feed.locationMile}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Direction</div>
                    <div class="detail-value">${directionFull || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Coordinates</div>
                    <div class="detail-value">${feed.lat}, ${feed.lon}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Feed ID</div>
                    <div class="detail-value">${feed.id}</div>
                </div>
            `;
        }

        function updateModalImage() {
            if (!currentModalFeedId) return;

            const modalVideo = document.getElementById('modalVideo');
            const existingImg = modalVideo.querySelector('img');

            if (feedStatus[currentModalFeedId]) {
                if (existingImg) {
                    // Update existing image
                    const baseSrc = existingImg.src.split('?')[0];
                    existingImg.src = `${baseSrc}?t=${Date.now()}`;
                } else {
                    // Create new image
                    modalVideo.innerHTML = `<img src="${API_URL}/api/feeds/${currentModalFeedId}/snapshot?t=${Date.now()}" crossorigin="anonymous" class="feed-stream-modal" data-feed-id="${currentModalFeedId}">`;
                }
            } else {
                modalVideo.innerHTML = '<div class="error">Feed offline</div>';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('feedModal').classList.remove('active');
            currentModalFeedId = null;
            if (modalRefreshIntervalId) {
                clearInterval(modalRefreshIntervalId);
                modalRefreshIntervalId = null;
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Close modal on background click
        document.getElementById('feedModal').addEventListener('click', (e) => {
            if (e.target.id === 'feedModal') closeModal();
        });

        // Stream Out Modal Functions
        function openStreamOutModal() {
            document.getElementById('streamOutModal').classList.add('active');
            // Load current config from backend
            loadStreamConfig();
        }

        function closeStreamOutModal() {
            document.getElementById('streamOutModal').classList.remove('active');
        }

        async function loadStreamConfig() {
            try {
                const response = await fetch(`${API_URL}/api/stream/config`);
                const config = await response.json();

                document.getElementById('streamEnabled').checked = config.enabled;
                document.getElementById('streamFormat').value = config.format || 'cot';
                document.getElementById('streamIP').value = config.ip || '127.0.0.1';
                document.getElementById('streamPort').value = config.port || 8087;
                document.getElementById('latticeUrl').value = config.latticeUrl || '';
                document.getElementById('latticeToken').value = config.latticeToken || '';
                document.getElementById('latticeIntegration').value = config.latticeIntegration || 'taiwan-cctv';

                // Update button state and format fields
                updateStreamButtonState(config.enabled);
                updateFormatFields();
            } catch (error) {
                console.error('Error loading stream config:', error);
            }
        }

        function updateFormatFields() {
            const format = document.getElementById('streamFormat').value;
            const cotFields = document.querySelectorAll('.cot-fields');
            const latticeFields = document.querySelectorAll('.lattice-fields');
            const cotInfo = document.querySelector('.cot-info');
            const latticeInfo = document.querySelector('.lattice-info');

            if (format === 'cot') {
                cotFields.forEach(el => el.style.display = 'block');
                latticeFields.forEach(el => el.style.display = 'none');
                cotInfo.style.display = 'block';
                latticeInfo.style.display = 'none';
            } else if (format === 'lattice') {
                cotFields.forEach(el => el.style.display = 'none');
                latticeFields.forEach(el => el.style.display = 'block');
                cotInfo.style.display = 'none';
                latticeInfo.style.display = 'block';
            }
        }

        async function saveStreamConfig() {
            const config = {
                enabled: document.getElementById('streamEnabled').checked,
                format: document.getElementById('streamFormat').value,
                ip: document.getElementById('streamIP').value,
                port: parseInt(document.getElementById('streamPort').value),
                latticeUrl: document.getElementById('latticeUrl').value,
                latticeToken: document.getElementById('latticeToken').value,
                latticeSandboxToken: document.getElementById('latticeSandboxToken').value,
                latticeIntegration: document.getElementById('latticeIntegration').value
            };

            try {
                const response = await fetch(`${API_URL}/api/stream/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    alert('Stream configuration saved successfully!');
                    updateStreamButtonState(config.enabled);
                    closeStreamOutModal();
                } else {
                    alert('Failed to save stream configuration');
                }
            } catch (error) {
                console.error('Error saving stream config:', error);
                alert('Error saving stream configuration');
            }
        }

        async function toggleStreaming() {
            const enabled = document.getElementById('streamEnabled').checked;
            updateStreamButtonState(enabled);
        }

        function updateStreamButtonState(enabled) {
            const btn = document.getElementById('streamOutBtn');
            if (enabled) {
                btn.classList.add('active');
                btn.textContent = 'Stream Out (ON)';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Stream Out';
            }
        }

        // Close stream modal on background click
        document.getElementById('streamOutModal').addEventListener('click', (e) => {
            if (e.target.id === 'streamOutModal') closeStreamOutModal();
        });

        // WebSocket Connection for Real-Time Updates
        function connectWebSocket() {
            console.log('Connecting to WebSocket...');
            ws = new WebSocket(`${WS_URL}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                if (wsReconnectTimeout) {
                    clearTimeout(wsReconnectTimeout);
                    wsReconnectTimeout = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting in 5 seconds...');
                ws = null;
                wsReconnectTimeout = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'detection':
                    // Update vehicle detection status
                    feedVehicleDetected[data.feed_id] = true;
                    updateWorkingCount();

                    // Update the badge on the feed card if visible
                    const card = document.querySelector(`.feed-card[data-feed-id="${data.feed_id}"]`);
                    if (card) {
                        const thumbnail = card.querySelector('.feed-thumbnail');
                        if (thumbnail && !thumbnail.querySelector('.vehicle-badge')) {
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        }
                    }

                    // Show notification in console with detection data
                    const detectionInfo = data.data || {};
                    const vehicleCount = detectionInfo.vehicle_count || 'unknown';
                    const vehicleTypes = detectionInfo.vehicle_types ? detectionInfo.vehicle_types.join(', ') : 'unknown types';
                    console.log(`ðŸš— Vehicle detected: ${data.feed_id} - ${vehicleCount} vehicles (${vehicleTypes})`);
                    break;

                case 'feed_status':
                    // Update feed status
                    feedStatus[data.feed_id] = data.is_working;
                    feedVehicleDetected[data.feed_id] = data.has_vehicles;
                    updateWorkingCount();

                    // Update badge based on status
                    const statusCard = document.querySelector(`.feed-card[data-feed-id="${data.feed_id}"]`);
                    if (statusCard) {
                        const thumbnail = statusCard.querySelector('.feed-thumbnail');
                        const badge = thumbnail?.querySelector('.vehicle-badge');

                        if (data.has_vehicles && !badge && thumbnail) {
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        } else if (!data.has_vehicles && badge) {
                            badge.remove();
                        }
                    }
                    break;

                case 'heartbeat':
                    // Server heartbeat - connection is alive
                    console.debug('WebSocket heartbeat received');
                    break;

                case 'stats':
                    // System statistics update
                    console.debug('Stats update received:', data.data);
                    break;

                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }

        // Expose API for YOLO integration
        window.cctvViewer = {
            getAllFeeds: () => allFeeds,
            getWorkingFeeds: () => allFeeds.filter(f => feedStatus[f.id]),
            getDisplayedFeeds: () => displayedFeeds,
            getFeedImage: (feedId) => document.querySelector(`img.feed-stream[data-feed-id="${feedId}"]`),
            getAllFeedImages: () => Array.from(document.querySelectorAll('img.feed-stream')),
            getFeedStatus: () => feedStatus,
            getWebSocket: () => ws
        };

        // Initialize
        loadFeeds();
        connectWebSocket();
    </script>
</body>
</html>
