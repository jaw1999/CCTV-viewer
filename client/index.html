<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Highway CCTV Viewer - Real-time</title>
    <link rel="stylesheet" href="styles/common.css">
    <style>
        /* Page-specific styles */
        .stream-modal {
            max-width: 500px;
            width: 90%;
        }

        .stream-config {
            padding: var(--spacing-xl);
        }

        .config-row {
            margin-bottom: var(--spacing-xl);
        }

        .config-row label {
            display: block;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-sm);
            font-size: 14px;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: var(--spacing-md);
            cursor: pointer;
            accent-color: var(--color-accent);
        }

        .toggle-label span {
            font-size: 16px;
            font-weight: 600;
        }

        .stream-info {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            font-size: 13px;
        }

        .stream-info p {
            margin-bottom: var(--spacing-md);
            color: var(--color-accent);
        }

        .stream-info ul {
            margin-left: var(--spacing-xl);
            color: var(--color-text-secondary);
        }

        .stream-info li {
            margin-bottom: var(--spacing-xs);
        }

        /* Search results count */
        .search-results {
            font-size: 12px;
            color: var(--color-text-tertiary);
            margin-top: var(--spacing-xs);
        }

        /* Connection time */
        .connection-time {
            font-size: 10px;
            opacity: 0.8;
            margin-left: var(--spacing-xs);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="header-title">
                <h1>Taiwan Highway CCTV Viewer</h1>
                <div class="header-actions">
                    <a href="map.html" class="btn" target="_blank">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        Map View
                    </a>
                    <a href="monitoring.html" class="btn btn-success" target="_blank">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        Monitoring
                    </a>
                </div>
            </div>
            <div id="connectionStatus" class="connection-status disconnected" role="status" aria-live="polite">
                <span class="connection-dot"></span>
                <span class="connection-text">Connecting...</span>
            </div>
        </div>

        <div class="stats" role="region" aria-label="Feed statistics">
            <div class="stat">Total: <span class="stat-value" id="totalCount">0</span></div>
            <div class="stat">Displayed: <span class="stat-value" id="displayedCount">0</span></div>
            <div class="stat">Online: <span class="stat-value" id="workingCount">0</span></div>
            <div class="stat">Vehicles: <span class="stat-value" id="vehicleCount">0</span></div>
            <div class="stat">Refresh: <span class="stat-value" id="refreshRate">2.0s</span></div>
        </div>

        <div class="controls">
            <div class="search-box" id="searchContainer">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                <input type="text"
                       id="searchInput"
                       placeholder="Search by location, road name, or ID..."
                       aria-label="Search feeds"
                       autocomplete="off">
                <button class="search-clear" id="searchClear" aria-label="Clear search">&times;</button>
                <div class="search-results" id="searchResults"></div>
            </div>
            <div class="filter-buttons" role="group" aria-label="Filter feeds">
                <button class="btn active" id="showAllBtn" data-filter="all" aria-pressed="true">Show All</button>
                <button class="btn" id="showWorkingBtn" data-filter="working" aria-pressed="false">Working Only</button>
                <button class="btn" id="showOccupiedBtn" data-filter="occupied" aria-pressed="false">TAI Occupied</button>
                <button class="btn" id="streamOutBtn" aria-haspopup="dialog">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Stream Out
                </button>
            </div>
        </div>
    </div>

    <div class="refresh-indicator" id="refreshIndicator" aria-hidden="true">
        <div class="loading-spinner"></div>
        <span>Updating feeds...</span>
    </div>

    <main class="grid-container" id="feedGrid" role="grid" aria-label="CCTV feed grid">
        <!-- Loading skeleton -->
        <div class="feed-card" aria-hidden="true">
            <div class="feed-thumbnail"><div class="skeleton skeleton-image"></div></div>
            <div class="feed-info">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
            </div>
        </div>
        <div class="feed-card" aria-hidden="true">
            <div class="feed-thumbnail"><div class="skeleton skeleton-image"></div></div>
            <div class="feed-info">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
            </div>
        </div>
        <div class="feed-card" aria-hidden="true">
            <div class="feed-thumbnail"><div class="skeleton skeleton-image"></div></div>
            <div class="feed-info">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
            </div>
        </div>
    </main>

    <!-- Feed Detail Modal -->
    <div class="modal" id="feedModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" id="modalClose" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-video" id="modalVideo"></div>
            <div class="modal-details" id="modalDetails"></div>
        </div>
    </div>

    <!-- Stream Out Configuration Modal -->
    <div class="modal" id="streamOutModal" role="dialog" aria-modal="true" aria-labelledby="streamModalTitle">
        <div class="modal-content stream-modal">
            <div class="modal-header">
                <h2 id="streamModalTitle">Stream Out Configuration</h2>
                <button class="modal-close" id="streamModalClose" aria-label="Close modal">&times;</button>
            </div>
            <div class="stream-config">
                <div class="config-row">
                    <label class="toggle-label">
                        <input type="checkbox" id="streamEnabled">
                        <span>Enable Streaming</span>
                    </label>
                </div>

                <div class="config-row">
                    <label for="streamFormat">Output Format:</label>
                    <select id="streamFormat" class="config-input">
                        <option value="cot">CoT (Cursor on Target)</option>
                        <option value="lattice">Lattice (Anduril)</option>
                        <option value="json" disabled>JSON (Coming Soon)</option>
                    </select>
                </div>

                <div class="config-row cot-fields">
                    <label for="streamIP">Destination IP:</label>
                    <input type="text" id="streamIP" class="config-input" placeholder="192.168.1.100" value="127.0.0.1">
                </div>

                <div class="config-row cot-fields">
                    <label for="streamPort">Port:</label>
                    <input type="number" id="streamPort" class="config-input" placeholder="8087" value="8087" min="1" max="65535">
                </div>

                <div class="config-row lattice-fields hidden">
                    <label for="latticeUrl">Lattice API URL:</label>
                    <input type="text" id="latticeUrl" class="config-input" placeholder="https://your-sandbox.lattice.anduril.com">
                </div>

                <div class="config-row lattice-fields hidden">
                    <label for="latticeToken">Environment Token:</label>
                    <input type="password" id="latticeToken" class="config-input" placeholder="Environment 'Lattice Auth Token'">
                    <small class="text-muted" style="font-size: 12px; display: block; margin-top: 4px;">Get from your environment details in Sandboxes</small>
                </div>

                <div class="config-row lattice-fields hidden">
                    <label for="latticeSandboxToken">Sandbox Token:</label>
                    <input type="password" id="latticeSandboxToken" class="config-input" placeholder="Account-level Sandboxes Bearer Token">
                    <small class="text-muted" style="font-size: 12px; display: block; margin-top: 4px;">Create in Account & Security - Bearer tokens (only for Sandboxes)</small>
                </div>

                <div class="config-row lattice-fields hidden">
                    <label for="latticeIntegration">Integration Name:</label>
                    <input type="text" id="latticeIntegration" class="config-input" placeholder="taiwan-cctv" value="taiwan-cctv">
                </div>

                <div class="config-row">
                    <button class="btn btn-primary btn-block" id="saveStreamConfig">Apply Configuration</button>
                </div>

                <div class="stream-info cot-info">
                    <p><strong>CoT Settings:</strong></p>
                    <ul>
                        <li>Protocol: UDP (fire and forget)</li>
                        <li>Marker Type: a-u-G (Unknown Ground)</li>
                        <li>Updates: Sent when vehicles detected</li>
                        <li>Callsign: TrafficCam-{ID}</li>
                    </ul>
                </div>

                <div class="stream-info lattice-info hidden">
                    <p><strong>Lattice Settings:</strong></p>
                    <ul>
                        <li>Protocol: HTTPS REST API</li>
                        <li>Entity Type: Unknown Ground</li>
                        <li>Updates: Real-time on vehicle detection</li>
                        <li>Expiry: 1 hour (auto-refresh)</li>
                    </ul>
                    <p><strong>Sandboxes Authentication:</strong></p>
                    <ul>
                        <li><strong>Environment Token:</strong> Get from environment details ("Lattice Auth Token")</li>
                        <li><strong>Sandbox Token:</strong> Create in Account & Security - Bearer tokens</li>
                        <li>Both tokens required for Sandbox environments</li>
                        <li>Production only needs Environment Token</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/utils.js"></script>
    <script>
        // ========================================
        // Configuration
        // ========================================
        const hostname = window.location.hostname;
        const API_URL = `http://${hostname}:8001`;
        const WS_URL = `ws://${hostname}:8001`;
        const REFRESH_INTERVAL = 2000;
        const MODAL_REFRESH_INTERVAL = 500;
        const SEARCH_DEBOUNCE_MS = 300;

        // ========================================
        // State
        // ========================================
        let allFeeds = [];
        let feedStatus = {};
        let feedVehicleDetected = {};
        let displayedFeeds = [];
        let filterMode = Storage.get('filterMode', 'all');
        let refreshIntervalId = null;
        let modalRefreshIntervalId = null;
        let currentModalFeedId = null;
        let ws = null;
        let wsReconnectTimeout = null;

        // ========================================
        // DOM Elements
        // ========================================
        const elements = {
            feedGrid: document.getElementById('feedGrid'),
            searchInput: document.getElementById('searchInput'),
            searchContainer: document.getElementById('searchContainer'),
            searchClear: document.getElementById('searchClear'),
            searchResults: document.getElementById('searchResults'),
            totalCount: document.getElementById('totalCount'),
            displayedCount: document.getElementById('displayedCount'),
            workingCount: document.getElementById('workingCount'),
            vehicleCount: document.getElementById('vehicleCount'),
            refreshRate: document.getElementById('refreshRate'),
            refreshIndicator: document.getElementById('refreshIndicator'),
            feedModal: document.getElementById('feedModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalVideo: document.getElementById('modalVideo'),
            modalDetails: document.getElementById('modalDetails'),
            modalClose: document.getElementById('modalClose'),
            streamOutModal: document.getElementById('streamOutModal'),
            streamModalClose: document.getElementById('streamModalClose'),
            streamEnabled: document.getElementById('streamEnabled'),
            streamFormat: document.getElementById('streamFormat'),
            saveStreamConfig: document.getElementById('saveStreamConfig'),
            streamOutBtn: document.getElementById('streamOutBtn')
        };

        // ========================================
        // Utilities
        // ========================================
        function translateDirection(dir) {
            const directions = {
                'N': 'North', 'S': 'South', 'E': 'East', 'W': 'West',
                'NE': 'Northeast', 'NW': 'Northwest', 'SE': 'Southeast', 'SW': 'Southwest',
                'C': 'Center'
            };
            return directions[dir] || dir;
        }

        function createEnglishDescription(feed) {
            const direction = translateDirection(feed.direction);
            return `${feed.roadName} at ${feed.locationMile} (${direction}bound)`;
        }

        // ========================================
        // Feed Loading
        // ========================================
        async function loadFeeds() {
            try {
                const response = await fetch(`${API_URL}/api/feeds`);
                if (!response.ok) throw new Error('Failed to fetch feeds');

                const data = await response.json();
                allFeeds = data.feeds;
                feedStatus = data.status;
                feedVehicleDetected = data.vehicleDetected || {};

                elements.totalCount.textContent = allFeeds.length;
                updateWorkingCount();
                applyFilters();

                startAutoRefresh();

            } catch (error) {
                console.error('Error loading feeds:', error);
                elements.feedGrid.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                        </div>
                        <div class="no-results-title">Unable to Connect</div>
                        <div class="no-results-text">Make sure the backend server is running on port 8001</div>
                        <button class="btn mt-lg" onclick="loadFeeds()">Retry</button>
                    </div>
                `;
                Toast.error('Failed to connect to backend server');
            }
        }

        // ========================================
        // Feed Display
        // ========================================
        function displayFeeds(feeds) {
            displayedFeeds = feeds;
            elements.displayedCount.textContent = feeds.length;

            if (feeds.length === 0) {
                const searchQuery = elements.searchInput.value;
                elements.feedGrid.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="m21 21-4.35-4.35"/>
                            </svg>
                        </div>
                        <div class="no-results-title">No feeds found</div>
                        <div class="no-results-text">
                            ${searchQuery ? `No results for "${searchQuery}". Try a different search term.` : 'No feeds match the current filter.'}
                        </div>
                    </div>
                `;
                return;
            }

            elements.feedGrid.innerHTML = feeds.map((feed, index) => {
                const englishDesc = createEnglishDescription(feed);
                const isWorking = feedStatus[feed.id] || false;
                const hasVehicles = feedVehicleDetected[feed.id] || false;

                return `
                    <div class="feed-card"
                         data-feed-id="${feed.id}"
                         tabindex="${index === 0 ? '0' : '-1'}"
                         role="gridcell"
                         aria-label="${englishDesc}, ${isWorking ? 'Online' : 'Offline'}${hasVehicles ? ', Vehicles detected' : ''}">
                        <div class="feed-thumbnail" id="thumb-${feed.id}">
                            ${isWorking ?
                                `<img src="${API_URL}/api/feeds/${feed.id}/snapshot?t=${Date.now()}"
                                      alt="${englishDesc}"
                                      class="feed-stream"
                                      crossorigin="anonymous"
                                      data-feed-id="${feed.id}"
                                      loading="lazy">
                                 ${hasVehicles ? '<div class="vehicle-badge">TAI OCCUPIED</div>' : ''}` :
                                ImageLoader.createOfflinePlaceholder()
                            }
                        </div>
                        <div class="feed-info">
                            <div class="feed-title">${feed.roadName || 'Unknown'} ${feed.locationMile || ''}</div>
                            <div class="feed-location">${englishDesc}</div>
                            <div class="feed-id">${feed.id}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.feed-card').forEach(card => {
                card.addEventListener('click', () => openFeed(card.dataset.feedId));
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        openFeed(card.dataset.feedId);
                    }
                });
            });

            // Initialize keyboard navigation
            KeyboardNav.init('#feedGrid', '.feed-card');
        }

        // ========================================
        // Auto Refresh
        // ========================================
        function startAutoRefresh() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);

            refreshIntervalId = setInterval(async () => {
                elements.refreshIndicator.classList.add('active');

                try {
                    const response = await fetch(`${API_URL}/api/feeds`);
                    const data = await response.json();
                    feedStatus = data.status;
                    feedVehicleDetected = data.vehicleDetected || {};
                    updateWorkingCount();
                } catch (error) {
                    console.error('Error refreshing feed status:', error);
                }

                const timestamp = Date.now();
                document.querySelectorAll('.feed-card').forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const isVisible = rect.top < window.innerHeight && rect.bottom > 0;
                    if (!isVisible) return;

                    const feedId = card.dataset.feedId;
                    const thumbnail = card.querySelector('.feed-thumbnail');
                    const isWorking = feedStatus[feedId];
                    const hasVehicles = feedVehicleDetected[feedId] || false;

                    if (isWorking) {
                        let img = thumbnail.querySelector('.feed-stream');
                        if (img) {
                            const baseSrc = img.src.split('?')[0];
                            img.src = `${baseSrc}?t=${timestamp}`;
                        } else {
                            const feed = allFeeds.find(f => f.id === feedId);
                            if (feed) {
                                const englishDesc = createEnglishDescription(feed);
                                thumbnail.innerHTML = `<img src="${API_URL}/api/feeds/${feedId}/snapshot?t=${timestamp}" alt="${englishDesc}" class="feed-stream" crossorigin="anonymous" data-feed-id="${feedId}" loading="lazy">`;
                            }
                        }

                        let badge = thumbnail.querySelector('.vehicle-badge');
                        if (hasVehicles && !badge) {
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        } else if (!hasVehicles && badge) {
                            badge.remove();
                        }
                    } else {
                        if (!thumbnail.querySelector('.offline-placeholder')) {
                            thumbnail.innerHTML = ImageLoader.createOfflinePlaceholder();
                        }
                    }
                });

                elements.refreshRate.textContent = `${(REFRESH_INTERVAL / 1000).toFixed(1)}s`;

                setTimeout(() => {
                    elements.refreshIndicator.classList.remove('active');
                }, 500);

            }, REFRESH_INTERVAL);
        }

        // ========================================
        // Stats Update
        // ========================================
        function updateWorkingCount() {
            const working = Object.values(feedStatus).filter(s => s).length;
            const vehicles = Object.values(feedVehicleDetected).filter(v => v).length;
            elements.workingCount.textContent = working;
            elements.vehicleCount.textContent = vehicles;
        }

        // ========================================
        // Search & Filter
        // ========================================
        const debouncedSearch = debounce((query) => {
            applyFilters();

            // Update search results count
            if (query) {
                elements.searchResults.textContent = `${displayedFeeds.length} result${displayedFeeds.length !== 1 ? 's' : ''}`;
            } else {
                elements.searchResults.textContent = '';
            }
        }, SEARCH_DEBOUNCE_MS);

        elements.searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            elements.searchContainer.classList.toggle('has-value', query.length > 0);
            debouncedSearch(query);
        });

        elements.searchClear.addEventListener('click', () => {
            elements.searchInput.value = '';
            elements.searchContainer.classList.remove('has-value');
            elements.searchResults.textContent = '';
            applyFilters();
            elements.searchInput.focus();
        });

        function setFilter(mode) {
            filterMode = mode;
            Storage.set('filterMode', mode);

            document.querySelectorAll('.filter-buttons .btn[data-filter]').forEach(btn => {
                const isActive = btn.dataset.filter === mode;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive);
            });

            applyFilters();
        }

        function applyFilters() {
            const searchQuery = elements.searchInput.value.toLowerCase();
            let filtered = allFeeds;

            if (searchQuery) {
                filtered = filtered.filter(feed => {
                    const searchStr = `${feed.roadName} ${feed.locationMile} ${feed.id} ${feed.description}`.toLowerCase();
                    return searchStr.includes(searchQuery);
                });
            }

            if (filterMode === 'working') {
                filtered = filtered.filter(f => feedStatus[f.id]);
            } else if (filterMode === 'occupied') {
                filtered = filtered.filter(f => feedVehicleDetected[f.id]);
            }

            displayFeeds(filtered);
        }

        // Set up filter button handlers
        document.querySelectorAll('.filter-buttons .btn[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => setFilter(btn.dataset.filter));
        });

        // Restore saved filter
        setFilter(filterMode);

        // ========================================
        // Feed Modal
        // ========================================
        function openFeed(feedId) {
            const feed = allFeeds.find(f => f.id === feedId);
            if (!feed) return;

            currentModalFeedId = feedId;
            const englishDesc = createEnglishDescription(feed);
            const directionFull = translateDirection(feed.direction);

            elements.modalTitle.textContent = englishDesc;
            elements.feedModal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Trap focus in modal
            A11y.trapFocus(elements.feedModal);

            updateModalImage();
            if (modalRefreshIntervalId) clearInterval(modalRefreshIntervalId);
            modalRefreshIntervalId = setInterval(updateModalImage, MODAL_REFRESH_INTERVAL);

            elements.modalDetails.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${englishDesc}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Road</div>
                    <div class="detail-value">${feed.roadName}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Mile Marker</div>
                    <div class="detail-value">${feed.locationMile}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Direction</div>
                    <div class="detail-value">${directionFull || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Coordinates</div>
                    <div class="detail-value">${feed.lat}, ${feed.lon}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Feed ID</div>
                    <div class="detail-value">${feed.id}</div>
                </div>
                <div class="detail-item" style="grid-column: 1 / -1; margin-top: var(--spacing-md);">
                    <a href="feed.html?id=${feed.id}" target="_blank" class="btn btn-primary btn-block">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        Watch Live (Faster Updates)
                    </a>
                </div>
            `;
        }

        function updateModalImage() {
            if (!currentModalFeedId) return;

            if (feedStatus[currentModalFeedId]) {
                const existingImg = elements.modalVideo.querySelector('img');
                if (existingImg) {
                    const baseSrc = existingImg.src.split('?')[0];
                    existingImg.src = `${baseSrc}?t=${Date.now()}`;
                } else {
                    elements.modalVideo.innerHTML = `<img src="${API_URL}/api/feeds/${currentModalFeedId}/snapshot?t=${Date.now()}" crossorigin="anonymous" alt="Feed preview">`;
                }
            } else {
                elements.modalVideo.innerHTML = ImageLoader.createOfflinePlaceholder();
            }
        }

        function closeModal() {
            elements.feedModal.classList.remove('active');
            document.body.style.overflow = '';
            currentModalFeedId = null;
            if (modalRefreshIntervalId) {
                clearInterval(modalRefreshIntervalId);
                modalRefreshIntervalId = null;
            }
        }

        elements.modalClose.addEventListener('click', closeModal);
        elements.feedModal.addEventListener('click', (e) => {
            if (e.target === elements.feedModal) closeModal();
        });

        // ========================================
        // Stream Out Modal
        // ========================================
        function openStreamOutModal() {
            elements.streamOutModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            loadStreamConfig();
            A11y.trapFocus(elements.streamOutModal);
        }

        function closeStreamOutModal() {
            elements.streamOutModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function loadStreamConfig() {
            try {
                const response = await fetch(`${API_URL}/api/stream/config`);
                const config = await response.json();

                elements.streamEnabled.checked = config.enabled;
                document.getElementById('streamFormat').value = config.format || 'cot';
                document.getElementById('streamIP').value = config.ip || '127.0.0.1';
                document.getElementById('streamPort').value = config.port || 8087;
                document.getElementById('latticeUrl').value = config.latticeUrl || '';
                document.getElementById('latticeToken').value = config.latticeToken || '';
                document.getElementById('latticeIntegration').value = config.latticeIntegration || 'taiwan-cctv';

                updateStreamButtonState(config.enabled);
                updateFormatFields();
            } catch (error) {
                console.error('Error loading stream config:', error);
                Toast.error('Failed to load stream configuration');
            }
        }

        function updateFormatFields() {
            const format = document.getElementById('streamFormat').value;
            const cotFields = document.querySelectorAll('.cot-fields');
            const latticeFields = document.querySelectorAll('.lattice-fields');
            const cotInfo = document.querySelector('.cot-info');
            const latticeInfo = document.querySelector('.lattice-info');

            if (format === 'cot') {
                cotFields.forEach(el => el.classList.remove('hidden'));
                latticeFields.forEach(el => el.classList.add('hidden'));
                cotInfo.classList.remove('hidden');
                latticeInfo.classList.add('hidden');
            } else if (format === 'lattice') {
                cotFields.forEach(el => el.classList.add('hidden'));
                latticeFields.forEach(el => el.classList.remove('hidden'));
                cotInfo.classList.add('hidden');
                latticeInfo.classList.remove('hidden');
            }
        }

        async function saveStreamConfig() {
            const config = {
                enabled: elements.streamEnabled.checked,
                format: document.getElementById('streamFormat').value,
                ip: document.getElementById('streamIP').value,
                port: parseInt(document.getElementById('streamPort').value),
                latticeUrl: document.getElementById('latticeUrl').value,
                latticeToken: document.getElementById('latticeToken').value,
                latticeSandboxToken: document.getElementById('latticeSandboxToken').value,
                latticeIntegration: document.getElementById('latticeIntegration').value
            };

            try {
                const response = await fetch(`${API_URL}/api/stream/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    Toast.success('Stream configuration saved successfully!');
                    updateStreamButtonState(config.enabled);
                    closeStreamOutModal();
                } else {
                    Toast.error('Failed to save stream configuration');
                }
            } catch (error) {
                console.error('Error saving stream config:', error);
                Toast.error('Error saving stream configuration');
            }
        }

        function updateStreamButtonState(enabled) {
            if (enabled) {
                elements.streamOutBtn.classList.add('active');
                elements.streamOutBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Stream Out (ON)
                `;
            } else {
                elements.streamOutBtn.classList.remove('active');
                elements.streamOutBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Stream Out
                `;
            }
        }

        elements.streamOutBtn.addEventListener('click', openStreamOutModal);
        elements.streamModalClose.addEventListener('click', closeStreamOutModal);
        elements.streamOutModal.addEventListener('click', (e) => {
            if (e.target === elements.streamOutModal) closeStreamOutModal();
        });
        document.getElementById('streamFormat').addEventListener('change', updateFormatFields);
        elements.saveStreamConfig.addEventListener('click', saveStreamConfig);
        elements.streamEnabled.addEventListener('change', () => {
            updateStreamButtonState(elements.streamEnabled.checked);
        });

        // ========================================
        // Keyboard Shortcuts
        // ========================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (elements.feedModal.classList.contains('active')) {
                    closeModal();
                } else if (elements.streamOutModal.classList.contains('active')) {
                    closeStreamOutModal();
                }
            }

            // Focus search on Ctrl/Cmd + K
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                elements.searchInput.focus();
                elements.searchInput.select();
            }
        });

        // ========================================
        // WebSocket Connection
        // ========================================
        function connectWebSocket() {
            ConnectionStatus.init('connectionStatus');
            ConnectionStatus.setStatus('connecting');

            ws = new WebSocket(`${WS_URL}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                ConnectionStatus.setStatus('connected');
                if (wsReconnectTimeout) {
                    clearTimeout(wsReconnectTimeout);
                    wsReconnectTimeout = null;
                }
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                    ConnectionStatus.updateLastSeen();
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                ConnectionStatus.setStatus('disconnected');
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting in 5 seconds...');
                ws = null;
                ConnectionStatus.setStatus('disconnected');
                wsReconnectTimeout = setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'detection':
                    feedVehicleDetected[data.feed_id] = true;
                    updateWorkingCount();

                    const card = document.querySelector(`.feed-card[data-feed-id="${data.feed_id}"]`);
                    if (card) {
                        const thumbnail = card.querySelector('.feed-thumbnail');
                        if (thumbnail && !thumbnail.querySelector('.vehicle-badge')) {
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        }
                    }

                    const detectionInfo = data.data || {};
                    console.log(`Vehicle detected: ${data.feed_id} - ${detectionInfo.vehicle_count || 'unknown'} vehicles`);
                    break;

                case 'feed_status':
                    feedStatus[data.feed_id] = data.is_working;
                    feedVehicleDetected[data.feed_id] = data.has_vehicles;
                    updateWorkingCount();

                    const statusCard = document.querySelector(`.feed-card[data-feed-id="${data.feed_id}"]`);
                    if (statusCard) {
                        const thumbnail = statusCard.querySelector('.feed-thumbnail');
                        const badge = thumbnail?.querySelector('.vehicle-badge');

                        if (data.has_vehicles && !badge && thumbnail) {
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        } else if (!data.has_vehicles && badge) {
                            badge.remove();
                        }
                    }
                    break;

                case 'heartbeat':
                    console.debug('WebSocket heartbeat received');
                    break;

                case 'stats':
                    console.debug('Stats update received:', data.data);
                    break;

                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }

        // ========================================
        // Public API
        // ========================================
        window.cctvViewer = {
            getAllFeeds: () => allFeeds,
            getWorkingFeeds: () => allFeeds.filter(f => feedStatus[f.id]),
            getDisplayedFeeds: () => displayedFeeds,
            getFeedImage: (feedId) => document.querySelector(`img.feed-stream[data-feed-id="${feedId}"]`),
            getAllFeedImages: () => Array.from(document.querySelectorAll('img.feed-stream')),
            getFeedStatus: () => feedStatus,
            getWebSocket: () => ws,
            toast: Toast
        };

        // ========================================
        // Initialize
        // ========================================
        loadFeeds();
        connectWebSocket();
    </script>
</body>
</html>
