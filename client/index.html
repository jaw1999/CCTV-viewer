<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taiwan Highway CCTV Viewer - Real-time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
        }

        .header {
            background: #2d2d2d;
            padding: 20px;
            border-bottom: 2px solid #0066cc;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #444;
            background: #1a1a1a;
            color: white;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: #0066cc;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: 2px solid #444;
            background: #2d2d2d;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #3d3d3d;
            border-color: #0066cc;
        }

        .btn.active {
            background: #0066cc;
            border-color: #0066cc;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 14px;
            color: #888;
        }

        .stat span {
            color: #0066cc;
            font-weight: bold;
        }

        .grid-container {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .feed-card {
            background: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .feed-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        .feed-thumbnail {
            width: 100%;
            height: 200px;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .feed-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .feed-thumbnail .loading {
            color: #888;
            font-size: 14px;
        }

        .feed-thumbnail .error {
            color: #ff6b6b;
            font-size: 14px;
        }

        .vehicle-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b00;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .feed-info {
            padding: 12px;
        }

        .feed-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .feed-location {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .feed-id {
            font-size: 11px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            font-size: 30px;
            color: #888;
            cursor: pointer;
            background: none;
            border: none;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-video {
            padding: 20px;
            text-align: center;
            background: #1a1a1a;
        }

        .modal-video img {
            max-width: 100%;
            max-height: 70vh;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .modal-details {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
        }

        .detail-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #fff;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #888;
            font-size: 18px;
        }

        .refresh-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #0066cc;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Taiwan Highway CCTV Viewer - Real-time</h1>
        <div class="stats">
            <div class="stat">Total: <span id="totalCount">0</span></div>
            <div class="stat">Displayed: <span id="displayedCount">0</span></div>
            <div class="stat">Online: <span id="workingCount">0</span></div>
            <div class="stat">Refresh Rate: <span id="refreshRate">0.0s</span></div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search by location, road name, or ID...">
            </div>
            <div class="filter-buttons">
                <button class="btn active" id="showAllBtn" onclick="setFilter('all')">Show All</button>
                <button class="btn" id="showWorkingBtn" onclick="setFilter('working')">Working Only</button>
                <button class="btn" id="showOccupiedBtn" onclick="setFilter('occupied')">TAI Occupied</button>
            </div>
        </div>
    </div>

    <div class="refresh-indicator" id="refreshIndicator">Updating feeds...</div>

    <div class="grid-container" id="feedGrid">
        <div class="no-results">Loading feeds from backend...</div>
    </div>

    <div class="modal" id="feedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-video" id="modalVideo"></div>
            <div class="modal-details" id="modalDetails"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8001';
        const REFRESH_INTERVAL = 2000; // 2 seconds for grid
        const MODAL_REFRESH_INTERVAL = 500; // 0.5 seconds for modal

        let allFeeds = [];
        let feedStatus = {};
        let feedVehicleDetected = {};
        let displayedFeeds = [];
        let filterMode = 'all';
        let refreshIntervalId = null;
        let modalRefreshIntervalId = null;
        let currentModalFeedId = null;

        // Translate direction codes to English
        function translateDirection(dir) {
            const directions = {
                'N': 'North', 'S': 'South', 'E': 'East', 'W': 'West',
                'NE': 'Northeast', 'NW': 'Northwest', 'SE': 'Southeast', 'SW': 'Southwest',
                'C': 'Center'
            };
            return directions[dir] || dir;
        }

        // Create English description from location data
        function createEnglishDescription(feed) {
            const direction = translateDirection(feed.direction);
            return `${feed.roadName} at ${feed.locationMile} (${direction}bound)`;
        }

        // Load feeds from backend API
        async function loadFeeds() {
            try {
                const response = await fetch(`${API_URL}/api/feeds`);
                const data = await response.json();

                allFeeds = data.feeds;
                feedStatus = data.status;
                feedVehicleDetected = data.vehicleDetected || {};

                document.getElementById('totalCount').textContent = allFeeds.length;
                updateWorkingCount();
                displayFeeds(allFeeds);

                // Start auto-refresh
                startAutoRefresh();

            } catch (error) {
                console.error('Error loading feeds:', error);
                document.getElementById('feedGrid').innerHTML = '<div class="no-results">Error connecting to backend. Make sure the server is running on port 8001.</div>';
            }
        }

        // Display feeds in grid
        function displayFeeds(feeds) {
            displayedFeeds = feeds;
            const grid = document.getElementById('feedGrid');
            document.getElementById('displayedCount').textContent = feeds.length;

            if (feeds.length === 0) {
                grid.innerHTML = '<div class="no-results">No feeds found matching your criteria.</div>';
                return;
            }

            grid.innerHTML = feeds.map(feed => {
                const englishDesc = createEnglishDescription(feed);
                const isWorking = feedStatus[feed.id] || false;
                const hasVehicles = feedVehicleDetected[feed.id] || false;
                const vehicleBadge = hasVehicles ? '<div class="vehicle-badge">TAI OCCUPIED</div>' : '';
                return `
                    <div class="feed-card" onclick="openFeed('${feed.id}')" data-feed-id="${feed.id}">
                        <div class="feed-thumbnail" id="thumb-${feed.id}">
                            ${isWorking ? `<img src="${API_URL}/api/feeds/${feed.id}/snapshot?t=${Date.now()}" alt="${englishDesc}" class="feed-stream" crossorigin="anonymous" data-feed-id="${feed.id}">${vehicleBadge}` : '<div class="error">Offline</div>'}
                        </div>
                        <div class="feed-info">
                            <div class="feed-title">${feed.roadName || 'Unknown'} ${feed.locationMile || ''}</div>
                            <div class="feed-location">${englishDesc}</div>
                            <div class="feed-id">${feed.id}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Auto-refresh visible thumbnails
        function startAutoRefresh() {
            if (refreshIntervalId) clearInterval(refreshIntervalId);

            refreshIntervalId = setInterval(async () => {
                const indicator = document.getElementById('refreshIndicator');
                indicator.style.display = 'block';

                const startTime = Date.now();

                // Update feed status from backend
                try {
                    const response = await fetch(`${API_URL}/api/feeds`);
                    const data = await response.json();
                    feedStatus = data.status;
                    feedVehicleDetected = data.vehicleDetected || {};
                    updateWorkingCount();
                } catch (error) {
                    console.error('Error refreshing feed status:', error);
                }

                // Update only VISIBLE feed thumbnails for performance
                const timestamp = Date.now();
                document.querySelectorAll('.feed-card').forEach(card => {
                    // Check if card is in viewport (simple check)
                    const rect = card.getBoundingClientRect();
                    const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

                    if (!isVisible) return; // Skip off-screen feeds

                    const feedId = card.dataset.feedId;
                    const thumbnail = card.querySelector('.feed-thumbnail');
                    const isWorking = feedStatus[feedId];
                    const hasVehicles = feedVehicleDetected[feedId] || false;

                    if (isWorking) {
                        // Check if image already exists
                        let img = thumbnail.querySelector('.feed-stream');
                        if (img) {
                            // Image exists, just refresh it
                            const baseSrc = img.src.split('?')[0];
                            img.src = `${baseSrc}?t=${timestamp}`;
                        } else {
                            // Feed came online, create image element
                            const feed = allFeeds.find(f => f.id === feedId);
                            if (feed) {
                                const englishDesc = createEnglishDescription(feed);
                                thumbnail.innerHTML = `<img src="${API_URL}/api/feeds/${feedId}/snapshot?t=${timestamp}" alt="${englishDesc}" class="feed-stream" crossorigin="anonymous" data-feed-id="${feedId}">`;
                            }
                        }

                        // Update vehicle badge
                        let badge = thumbnail.querySelector('.vehicle-badge');
                        if (hasVehicles && !badge) {
                            // Add badge if vehicles detected
                            thumbnail.insertAdjacentHTML('beforeend', '<div class="vehicle-badge">TAI OCCUPIED</div>');
                        } else if (!hasVehicles && badge) {
                            // Remove badge if no vehicles
                            badge.remove();
                        }
                    } else {
                        // Feed went offline, show error
                        if (!thumbnail.querySelector('.error')) {
                            thumbnail.innerHTML = '<div class="error">Offline</div>';
                        }
                    }
                });

                // Show actual refresh interval, not elapsed time
                document.getElementById('refreshRate').textContent = `${(REFRESH_INTERVAL / 1000).toFixed(1)}s`;

                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 500);

            }, REFRESH_INTERVAL);
        }

        // Update working count
        function updateWorkingCount() {
            const working = Object.values(feedStatus).filter(s => s).length;
            document.getElementById('workingCount').textContent = working;
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();

            const filtered = allFeeds.filter(feed => {
                const searchStr = `${feed.roadName} ${feed.locationMile} ${feed.id} ${feed.description}`.toLowerCase();
                return searchStr.includes(query);
            });

            applyFilters(filtered);
        });

        // Filter functionality
        function setFilter(mode) {
            filterMode = mode;

            document.getElementById('showAllBtn').classList.toggle('active', mode === 'all');
            document.getElementById('showWorkingBtn').classList.toggle('active', mode === 'working');
            document.getElementById('showOccupiedBtn').classList.toggle('active', mode === 'occupied');

            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            let filtered = allFeeds;

            if (searchQuery) {
                filtered = filtered.filter(feed => {
                    const searchStr = `${feed.roadName} ${feed.locationMile} ${feed.id} ${feed.description}`.toLowerCase();
                    return searchStr.includes(searchQuery);
                });
            }

            applyFilters(filtered);
        }

        function applyFilters(feeds) {
            if (filterMode === 'working') {
                feeds = feeds.filter(f => feedStatus[f.id]);
            } else if (filterMode === 'occupied') {
                feeds = feeds.filter(f => feedVehicleDetected[f.id]);
            }
            displayFeeds(feeds);
        }

        // Open feed in modal
        function openFeed(feedId) {
            const feed = allFeeds.find(f => f.id === feedId);
            if (!feed) return;

            // Clear any existing modal content first
            document.getElementById('modalVideo').innerHTML = '';

            currentModalFeedId = feedId;

            const englishDesc = createEnglishDescription(feed);
            const directionFull = translateDirection(feed.direction);

            document.getElementById('modalTitle').textContent = englishDesc;

            // Show modal
            document.getElementById('feedModal').classList.add('active');

            // Start fast refresh for modal
            updateModalImage();
            if (modalRefreshIntervalId) clearInterval(modalRefreshIntervalId);
            modalRefreshIntervalId = setInterval(updateModalImage, MODAL_REFRESH_INTERVAL);

            // Update details
            document.getElementById('modalDetails').innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Location</div>
                    <div class="detail-value">${englishDesc}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Road</div>
                    <div class="detail-value">${feed.roadName}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Mile Marker</div>
                    <div class="detail-value">${feed.locationMile}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Direction</div>
                    <div class="detail-value">${directionFull || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Coordinates</div>
                    <div class="detail-value">${feed.lat}, ${feed.lon}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Feed ID</div>
                    <div class="detail-value">${feed.id}</div>
                </div>
            `;
        }

        function updateModalImage() {
            if (!currentModalFeedId) return;

            const modalVideo = document.getElementById('modalVideo');
            const existingImg = modalVideo.querySelector('img');

            if (feedStatus[currentModalFeedId]) {
                if (existingImg) {
                    // Update existing image
                    const baseSrc = existingImg.src.split('?')[0];
                    existingImg.src = `${baseSrc}?t=${Date.now()}`;
                } else {
                    // Create new image
                    modalVideo.innerHTML = `<img src="${API_URL}/api/feeds/${currentModalFeedId}/snapshot?t=${Date.now()}" crossorigin="anonymous" class="feed-stream-modal" data-feed-id="${currentModalFeedId}">`;
                }
            } else {
                modalVideo.innerHTML = '<div class="error">Feed offline</div>';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('feedModal').classList.remove('active');
            currentModalFeedId = null;
            if (modalRefreshIntervalId) {
                clearInterval(modalRefreshIntervalId);
                modalRefreshIntervalId = null;
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Close modal on background click
        document.getElementById('feedModal').addEventListener('click', (e) => {
            if (e.target.id === 'feedModal') closeModal();
        });

        // Expose API for YOLO integration
        window.cctvViewer = {
            getAllFeeds: () => allFeeds,
            getWorkingFeeds: () => allFeeds.filter(f => feedStatus[f.id]),
            getDisplayedFeeds: () => displayedFeeds,
            getFeedImage: (feedId) => document.querySelector(`img.feed-stream[data-feed-id="${feedId}"]`),
            getAllFeedImages: () => Array.from(document.querySelectorAll('img.feed-stream')),
            getFeedStatus: () => feedStatus
        };

        // Initialize
        loadFeeds();
    </script>
</body>
</html>
